<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Estoque</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=">
</head>
<script>
    window.onerror = function (msg, url, line, col, error) {
        alert("Erro JS: " + msg + "\nLinha: " + line);
        // Also show in document body if alert is blocked
        const div = document.createElement('div');
        div.style.position = 'fixed';
        div.style.top = '0';
        div.style.left = '0';
        div.style.width = '100%';
        div.style.background = 'red';
        div.style.color = 'white';
        div.style.padding = '20px';
        div.style.zIndex = '10000';
        div.innerHTML = `<strong>Erro Cr√≠tico:</strong> ${msg}<br>Linha: ${line}`;
        document.body.appendChild(div);
        return false;
    };
</script>

<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Gest√£o</h2>
                <p>Mercadorias</p>
                <button id="theme-toggle" class="btn-icon" style="position: absolute; top: 1rem; right: 1rem;"
                    onclick="toggleTheme()">
                    üåó
                </button>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-btn active" onclick="switchTab('dashboard')">
                    üìä Painel Geral
                </button>
                <button class="nav-btn" onclick="switchTab('entries')">
                    üì• Entrada no estoque
                </button>
                <button class="nav-btn" onclick="switchTab('stock')">
                    üì¶ Estoque Detalhado
                </button>
                <button class="nav-btn" onclick="switchTab('exits')">
                    üì§ Vendas
                </button>
                <button class="nav-btn" onclick="switchTab('history')">
                    üìú Hist√≥rico
                </button>
                <button class="nav-btn" onclick="switchTab('actions')">
                    ‚öôÔ∏è A√ß√µes
                </button>
                <button class="nav-btn" onclick="switchTab('reports')">
                    üìÑ Relat√≥rios
                </button>
                <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button class="nav-btn" onclick="logout()" style="color: var(--danger-color);">
                        üö™ Sair
                    </button>
                </div>
            </nav>
            <div class="sidebar-footer">
                <p>¬© 2026</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="main-app" style="display: none;">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section active">
                <header>
                    <h1>Vis√£o Geral</h1>
                    <p class="subtitle">Resumo de estoque e movimenta√ß√µes</p>
                </header>

                <div class="stats-grid" id="stats-container">
                    <!-- Dynamically filled -->
                </div>

                <div class="card">
                    <div class="section-title">An√°lise de Movimenta√ß√£o (30 dias)</div>
                    <canvas id="movementChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- VIEW: STOCK DETAILS -->
            <div id="view-stock" class="view-section">
                <header>
                    <h1>Estoque Detalhado</h1>
                    <p class="subtitle">Vis√£o por Loja e Tipo</p>
                </header>
                <div class="card">
                    <div id="stock-details-container">Checking stock...</div>
                </div>
            </div>

            <!-- VIEW: ENTRIES (COMPRAS) -->
            <div id="view-entries" class="view-section">
                <header>
                    <h1>Entrada no estoque</h1>
                    <p class="subtitle">Registrar compra de mercadoria</p>
                </header>

                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div class="section-title">Formul√°rio de Entrada no estoque</div>
                    <form id="buy-form">
                        <div class="form-group">
                            <label>Loja / Ponto</label>
                            <select name="point_id" class="point-select" required></select>
                        </div>
                        <div class="form-group">
                            <label>Produto / Produto</label>
                            <select name="gold_type" required class="gold-type-select">
                                <!-- Filled by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantidade</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" step="0.01" name="weight" placeholder="Ex: 10" required
                                    style="flex: 2;">
                                <select name="unit"
                                    style="flex: 1; padding: 0.75rem; border-radius: 8px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="g">Unid / Gramas</option>
                                    <option value="kg">Kilos</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Custo Total (R$)</label>
                            <input type="number" step="0.01" name="price" placeholder="Ex: 500.00" required>
                        </div>
                        <div class="form-group">
                            <label>Fornecedor (Opcional)</label>
                            <input type="text" name="customer" placeholder="Nome do Fornecedor">
                        </div>
                        <button type="submit" class="btn btn-primary">Registrar Entrada no estoque</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: EXITS (VENDAS) -->
            <div id="view-exits" class="view-section">
                <header>
                    <h1>Vendas</h1>
                    <p class="subtitle">Registrar venda de mercadoria</p>
                </header>

                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div class="section-title">Formul√°rio de Venda</div>
                    <form id="sell-form">
                        <div class="form-group">
                            <label>Loja / Ponto</label>
                            <select name="point_id" class="point-select" required></select>
                        </div>
                        <div class="form-group">
                            <label>Produto / Produto</label>
                            <select name="gold_type" required class="gold-type-select">
                                <!-- Filled by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cliente / Destino</label>
                            <input type="text" name="customer" placeholder="Nome do Cliente" required>
                        </div>
                        <div class="form-group">
                            <label>Quantidade</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="number" step="0.01" name="weight" placeholder="Ex: 2" required
                                    style="flex: 2;">
                                <select name="unit"
                                    style="flex: 1; padding: 0.75rem; border-radius: 8px; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="g">Unid / Gramas</option>
                                    <option value="kg">Kilos</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Valor Venda (R$)</label>
                            <input type="number" step="0.01" name="price" placeholder="Ex: 100.00" required>
                        </div>

                        <!-- Delivery Toggle -->
                        <div class="form-group"
                            style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                            <input type="checkbox" id="delivery-check" style="width: auto;">
                            <label for="delivery-check" style="margin: 0; cursor: pointer;">Entrega?</label>
                        </div>

                        <!-- Delivery Fields (Hidden) -->
                        <div id="delivery-fields"
                            style="display: none; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label>Entregador</label>
                                <select name="courier_id" class="courier-select">
                                    <option value="">Selecione...</option>
                                </select>
                                <input type="text" name="delivery_courier" placeholder="Nome (caso n√£o cadastrado)"
                                    style="margin-top:0.5rem">
                            </div>
                            <div class="form-group">
                                <label>Hora</label>
                                <input type="time" name="delivery_time">
                            </div>
                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="number" step="0.01" name="delivery_cost" placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" name="date" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Registrar Venda</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: HISTORY -->
            <div id="view-history" class="view-section">
                <header>
                    <h1>Hist√≥rico</h1>
                    <p class="subtitle">Log completo de transa√ß√µes</p>
                </header>
                <div class="transactions-section">
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Produto</th>
                                    <th>Cliente</th>
                                    <th>Qtd</th>
                                    <th>Valor</th>
                                    <th>Entrega</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-body">
                                <!-- Filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: ACTIONS (Management) -->
            <div id="view-actions" class="view-section">
                <header>
                    <h1>Gerenciamento</h1>
                    <p class="subtitle">Produtos, Pontos e Entregadores</p>
                </header>

                <div class="forms-grid">
                    <!-- Categories -->
                    <div class="card">
                        <div class="section-title">Produtos</div>
                        <button id="btn-add-type" class="btn btn-primary" style="margin-bottom: 1rem">+ Nova
                            Produto</button>
                        <button id="btn-adjust-stock" class="btn" style="background: var(--text-secondary);">Ajuste
                            Manual</button>
                    </div>

                    <!-- Points -->
                    <div class="card">
                        <div class="section-title">Pontos / Lojas</div>
                        <form id="point-form">
                            <div class="form-group">
                                <input type="text" name="name" placeholder="Nome da Loja" required>
                            </div>
                            <div class="form-group">
                                <input type="text" name="address" placeholder="Bairro / Endere√ßo" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar Ponto</button>
                        </form>
                        <ul id="points-list"
                            style="margin-top: 1rem; color: var(--text-secondary); padding-left: 1rem;"></ul>
                    </div>

                    <!-- Couriers -->
                    <div class="card">
                        <div class="section-title">Motoboys</div>
                        <form id="courier-form">
                            <div class="form-group">
                                <input type="text" name="name" placeholder="Nome" required>
                            </div>
                            <div class="form-group">
                                <input type="text" name="phone" placeholder="Telefone">
                            </div>
                            <div class="form-group">
                                <input type="number" step="0.01" name="default_fee" placeholder="Taxa Padr√£o">
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar Motoboy</button>
                        </form>
                        <ul id="couriers-list"
                            style="margin-top: 1rem; color: var(--text-secondary); padding-left: 1rem;"></ul>
                    </div>

                    <!-- Custom Units -->
                    <div class="card">
                        <div class="section-title">Unidades de Medida</div>
                        <form id="unit-form">
                            <div class="form-group">
                                <input type="text" name="name" placeholder="Nome (Ex: Metro, Litro)" required>
                            </div>
                            <div class="form-group">
                                <input type="text" name="symbol" placeholder="S√≠mbolo (Ex: m, L)" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar Unidade</button>
                        </form>
                        <ul id="units-list" style="margin-top: 1rem; color: var(--text-secondary); padding-left: 1rem;">
                        </ul>
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="view-section">
                <header>
                    <h1>Relat√≥rios</h1>
                    <p class="subtitle">Gerar PDF de movimenta√ß√µes</p>
                </header>

                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <div class="section-title">Configurar Relat√≥rio</div>
                    <form id="report-form" style="margin-top: 1rem;">
                        <div class="form-group">
                            <label>Data Inicial</label>
                            <input type="date" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label>Data Final</label>
                            <input type="date" name="end_date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">üìÑ Gerar Relat√≥rio</button>
                    </form>
                </div>
            </div>

        </main>

    </div>

    <!-- LOGIN / REGISTER VIEW (Overlay) -->
    <div id="view-login" style="display: none;"> <!-- Initially hidden, JS will show if needed -->
        <div class="login-card">
            <div id="login-section">
                <div class="login-header">
                    <h1>Bem-Vindo</h1>
                    <p>Fa√ßa login para continuar</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label>Usu√°rio</label>
                        <input type="text" name="username" placeholder="Seu usu√°rio" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" name="password" placeholder="Sua senha" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-bottom: 1rem;">Entrar</button>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        N√£o tem conta? <a href="#" onclick="toggleAuth('register')"
                            style="color: var(--accent-primary);">Criar conta</a>
                    </p>
                </form>
            </div>

            <div id="register-section" style="display: none;">
                <div class="login-header">
                    <h1>Criar Conta</h1>
                    <p>Registro r√°pido</p>
                </div>
                <form id="register-form">
                    <div class="form-group">
                        <label>Novo Usu√°rio</label>
                        <input type="text" name="username" placeholder="Escolha um usu√°rio" required>
                    </div>
                    <div class="form-group">
                        <label>Senha</label>
                        <input type="password" name="password" placeholder="Escolha uma senha" required>
                    </div>
                    <button type="submit" class="btn btn-success"
                        style="background: var(--success-color); color:white; margin-bottom: 1rem;">Cadastrar</button>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        J√° tem conta? <a href="#" onclick="toggleAuth('login')"
                            style="color: var(--accent-primary);">Fazer Login</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Type Modal -->
    <div id="stock-item-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" id="close-stock-item">&times;</span>
            <h2 id="stock-item-title">Detalhes do Estoque</h2>
            <div id="stock-item-history" style="margin-top: 1rem; max-height: 400px; overflow-y: auto;">
                <p>Carregando...</p>
            </div>
        </div>
    </div>

    <div id="type-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" id="close-type">&times;</span>
            <h2>Novo Produto</h2>
            <form id="type-form" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label>Nome da Produto</label>
                    <input type="text" name="type_name" placeholder="Ex: Bebidas, Eletronicos..." required>
                </div>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" id="close-edit">&times;</span>
            <h2>Editar Transa√ß√£o</h2>
            <form id="edit-form" style="margin-top: 1.5rem;">
                <input type="hidden" name="id">
                <input type="hidden" name="type"> <!-- BUY or SELL -->

                <div class="form-group">
                    <label>Data</label>
                    <input type="date" name="date" required>
                </div>

                <div class="form-group">
                    <label>Produto</label>
                    <select name="gold_type_id" required class="gold-type-select">
                        <!-- Filled by JS -->
                    </select>
                </div>

                <div class="form-group">
                    <label>Qtd</label>
                    <input type="number" step="0.01" name="weight_grams" required>
                </div>

                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" step="0.01" name="price" required>
                </div>

                <div class="form-group">
                    <label>Cliente / Fornecedor</label>
                    <input type="text" name="customer_name">
                </div>

                <!-- Fields only for Sales -->
                <div id="edit-sale-fields">
                    <div class="form-group">
                        <label>Entregador</label>
                        <input type="text" name="delivery_courier">
                    </div>
                    <div class="form-group">
                        <label>Hora</label>
                        <input type="time" name="delivery_time">
                    </div>
                    <div class="form-group">
                        <label>Custo</label>
                        <input type="number" step="0.01" name="delivery_cost">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Atualizar</button>
            </form>
        </div>
    </div>

    <!-- Adjust Stock Modal -->
    <div id="adjust-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" id="close-adjust">&times;</span>
            <h2>Ajuste de Estoque</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Use valores positivos para adicionar e
                negativos para remover.</p>
            <form id="adjust-form">
                <div class="form-group">
                    <label>Produto</label>
                    <select name="gold_type_id" required class="gold-type-select"></select>
                </div>
                <div class="form-group">
                    <label>Qtd (+/-)</label>
                    <input type="number" step="0.01" name="weight_grams" placeholder="Ex: -10 ou 10" required>
                </div>
                <div class="form-group">
                    <label>Motivo</label>
                    <input type="text" name="reason" placeholder="Ex: Perda, erro de contagem" required>
                </div>
                <button type="submit" class="btn btn-primary">Aplicar</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" id="close-settings">&times;</span>
            <h2>Configura√ß√µes</h2>
            <form id="settings-form" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label>Nome de Usu√°rio</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Novo Senha (opcional)</label>
                    <input type="password" name="new_password">
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" name="confirm_new_password">
                </div>
                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="app.js"></script>
</body>

</html>