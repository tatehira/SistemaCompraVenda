{"version":3,"sources":["../../../../src/actions/transactions.ts","../../../../.next-internal/server/app/dashboard/inventory/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server'\r\n\r\nimport db from '@/lib/db'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { writeFile, mkdir } from 'fs/promises'\r\nimport path from 'path'\r\nimport { getSession } from './auth'\r\n\r\n// Helper to save file\r\nasync function saveFile(file: File | null) {\r\n    if (!file || file.size === 0) return null\r\n\r\n    const bytes = await file.arrayBuffer()\r\n    const buffer = Buffer.from(bytes)\r\n\r\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads')\r\n    await mkdir(uploadDir, { recursive: true })\r\n\r\n    const filename = `${Date.now()}-${file.name.replace(/\\s/g, '_')}`\r\n    const filepath = path.join(uploadDir, filename)\r\n\r\n    await writeFile(filepath, buffer)\r\n    return `/uploads/${filename}`\r\n}\r\n\r\nexport async function buy(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    let weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const file = formData.get('receipt') as File\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    // NORMALIZE TO GRAMS\r\n    if (unit === 'kg') {\r\n        weight = weight * 1000\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit) \r\n        VALUES ('BUY', ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        // We store 'weight' (grams) but keep 'unit' as the ORIGINAL input unit for reference if needed, \r\n        // OR we standardize 'unit' to 'g' in DB? \r\n        // User wants \"Entrou 100kg\". If we store 'g', we lose that it was input as kg.\r\n        // Let's store the NORMALIZED weight for math, but maybe we can store the unit context?\r\n        // Actually, \"Unit\" column in DB was used for grouping. \r\n        // Better strategy: Store everything as 'g' in DB for consistency in grouping. \r\n        // The \"Unit\" column becomes less relevant for calculation, but maybe useful for \"Original Input\".\r\n        // However, to make 100kg - 100g math work easily, we must group by GoldTypeId ONLY, not (GoldTypeId + Unit).\r\n        // So we will force unit to 'g' in the DB or ignore it in grouping.\r\n\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function sell(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    let weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    // Delivery fields\r\n    const deliveryCourierName = formData.get('delivery_courier') as string\r\n    let deliveryCost = 0\r\n\r\n    // If courier selected, fetch standard fee from DB\r\n    if (deliveryCourierName) {\r\n        const courier = db.prepare('SELECT fee FROM couriers WHERE name = ? AND user_id = ?').get(deliveryCourierName, userId) as any\r\n        if (courier) {\r\n            deliveryCost = courier.fee || 0\r\n        }\r\n    }\r\n\r\n    const file = formData.get('receipt') as File\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    // NORMALIZE TO GRAMS\r\n    if (unit === 'kg') {\r\n        weight = weight * 1000\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit, delivery_courier, delivery_cost) \r\n        VALUES ('SELL', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit, deliveryCourierName, deliveryCost)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function getInventory() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    // Calculate inventory\r\n    // Group by Point -> Gold Type ONLY (Ignore unit column for grouping, merge everything to grams)\r\n    const txs = db.prepare(`\r\n        SELECT t.type, t.weight_grams, gt.name as gold_name, p.name as point_name \r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n    `).all(userId) as any[]\r\n\r\n    const inventory: any = {}\r\n\r\n    txs.forEach(tx => {\r\n        const point = tx.point_name || 'Geral'\r\n        const gold = tx.gold_name || 'Desconhecido'\r\n        // Key is just Point + Gold. We aggregate ALL units here.\r\n        const key = `${point}-${gold}`\r\n\r\n        if (!inventory[key]) {\r\n            inventory[key] = {\r\n                point,\r\n                gold,\r\n                stock_grams: 0\r\n            }\r\n        }\r\n\r\n        if (tx.type === 'BUY') inventory[key].stock_grams += tx.weight_grams\r\n        if (tx.type === 'SELL') inventory[key].stock_grams -= tx.weight_grams\r\n    })\r\n\r\n    return Object.values(inventory).filter((i: any) => Math.abs(i.stock_grams) > 0.001)\r\n}\r\n\r\nexport async function getTransactions() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    return db.prepare(`\r\n        SELECT t.*, gt.name as gold_name, p.name as point_name\r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n        ORDER BY date DESC\r\n    `).all(userId)\r\n}\r\n\r\nexport async function getDailySales() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    // SQLite: strftime('%Y-%m-%d', date) extracts the date part\r\n    // We get last 30 days of sales\r\n    return db.prepare(`\r\n        SELECT strftime('%Y-%m-%d', date) as date, SUM(price) as total\r\n        FROM transactions\r\n        WHERE type = 'SELL' AND user_id = ?\r\n        GROUP BY date\r\n        ORDER BY date ASC\r\n        LIMIT 30\r\n    `).all(userId)\r\n}\r\n\r\nexport async function getCustomers() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    const result = db.prepare(`\r\n        SELECT DISTINCT customer_name \r\n        FROM transactions \r\n        WHERE user_id = ? \r\n        AND customer_name IS NOT NULL \r\n        AND customer_name != ''\r\n        ORDER BY customer_name ASC\r\n    `).all(userId) as any[]\r\n\r\n    return result.map(r => r.customer_name)\r\n}\r\n\r\nexport async function getReports(startDate: string, endDate: string, pointId?: number, customerName?: string) {\r\n    const session = await getSession()\r\n    if (!session) return { transactions: [], summary: { totalBuy: 0, totalSell: 0, balance: 0, totalBuyWeight: 0, totalSellWeight: 0 } }\r\n    const userId = Number(session.sub)\r\n\r\n    let query = `\r\n        SELECT t.*, gt.name as gold_name, p.name as point_name\r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ? \r\n        AND date(t.date) >= date(?) \r\n        AND date(t.date) <= date(?)\r\n    `\r\n\r\n    const params: any[] = [userId, startDate, endDate]\r\n\r\n    if (pointId) {\r\n        query += ` AND t.point_id = ?`\r\n        params.push(pointId)\r\n    }\r\n\r\n    if (customerName) {\r\n        query += ` AND t.customer_name = ?`\r\n        params.push(customerName)\r\n    }\r\n\r\n    query += ` ORDER BY t.date DESC`\r\n\r\n    const transactions = db.prepare(query).all(...params) as any[]\r\n\r\n    const summary = transactions.reduce((acc, tx) => {\r\n        if (tx.type === 'BUY') {\r\n            acc.totalBuy += tx.price\r\n            acc.totalBuyWeight += tx.weight_grams\r\n            acc.balance -= tx.price\r\n        } else if (tx.type === 'SELL') {\r\n            acc.totalSell += tx.price\r\n            acc.totalSellWeight += tx.weight_grams\r\n            acc.balance += tx.price\r\n        }\r\n        return acc\r\n    }, { totalBuy: 0, totalSell: 0, balance: 0, totalBuyWeight: 0, totalSellWeight: 0 })\r\n\r\n    return { transactions, summary }\r\n}\r\n","export {getSession as '001cff6da69649cb3538ebb44b85726acfda477617'} from 'ACTIONS_MODULE0'\nexport {logout as '00f5ae00e140bafd8c394ea98ad441ac36c1f2b778'} from 'ACTIONS_MODULE0'\nexport {register as '400005926efb722f25cb6dbbee9d650d9ce8a30e42'} from 'ACTIONS_MODULE0'\nexport {login as '40b73d41e742e5c9864de0c62d5bd2bf172ed6c6d1'} from 'ACTIONS_MODULE0'\nexport {logout as '00f5ae00e140bafd8c394ea98ad441ac36c1f2b778'} from 'ACTIONS_MODULE0'\nexport {getCustomers as '002b6512083828ceae5a051006e3a227e34d293b12'} from 'ACTIONS_MODULE1'\nexport {getInventory as '003324c74d0aa8c732b6ab05246d9f2eb2e7db5f56'} from 'ACTIONS_MODULE1'\nexport {getTransactions as '00b1aa0a5aabcd51d7e4770e006ea38d2077a06119'} from 'ACTIONS_MODULE1'\nexport {getDailySales as '00f8b6b51ec039725d13a2c470924b629bd2c60752'} from 'ACTIONS_MODULE1'\nexport {buy as '40a6bd7a98cbdb2610d87168772495a140cc23b2bb'} from 'ACTIONS_MODULE1'\nexport {sell as '40f2e801184a8ed1f430e97bac6910394b6cc2bfc2'} from 'ACTIONS_MODULE1'\nexport {getReports as '7882091f6bdb971a029c4d6ef49e1a7ea0e486c1d8'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"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"}