{"version":3,"sources":["../../../../src/actions/transactions.ts","../../../../.next-internal/server/app/dashboard/inventory/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["'use server'\r\n\r\nimport db from '@/lib/db'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { writeFile, mkdir } from 'fs/promises'\r\nimport path from 'path'\r\nimport { getSession } from './auth'\r\n\r\n// Helper to save file\r\nasync function saveFile(file: File | null) {\r\n    if (!file || file.size === 0) return null\r\n\r\n    const bytes = await file.arrayBuffer()\r\n    const buffer = Buffer.from(bytes)\r\n\r\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads')\r\n    await mkdir(uploadDir, { recursive: true })\r\n\r\n    const filename = `${Date.now()}-${file.name.replace(/\\s/g, '_')}`\r\n    const filepath = path.join(uploadDir, filename)\r\n\r\n    await writeFile(filepath, buffer)\r\n    return `/uploads/${filename}`\r\n}\r\n\r\nexport async function buy(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    const weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const file = formData.get('receipt') as File\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit) \r\n        VALUES ('BUY', ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function sell(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    const weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    // Delivery fields\r\n    const deliveryCourier = formData.get('delivery_courier') as string\r\n    const deliveryCost = parseFloat(formData.get('delivery_cost') as string) || 0\r\n\r\n    const file = formData.get('receipt') as File\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit, delivery_courier, delivery_cost) \r\n        VALUES ('SELL', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit, deliveryCourier, deliveryCost)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function getInventory() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    // Calculate inventory\r\n    // Group by Point -> Gold Type -> Unit\r\n    const txs = db.prepare(`\r\n        SELECT t.type, t.weight_grams, t.unit, gt.name as gold_name, p.name as point_name \r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n    `).all(userId) as any[]\r\n\r\n    const inventory: any = {}\r\n\r\n    txs.forEach(tx => {\r\n        const point = tx.point_name || 'Geral'\r\n        const gold = tx.gold_name || 'Desconhecido'\r\n        const unit = tx.unit || 'g'\r\n        const key = `${point}-${gold}-${unit}`\r\n\r\n        if (!inventory[key]) {\r\n            inventory[key] = {\r\n                point,\r\n                gold,\r\n                unit,\r\n                stock: 0\r\n            }\r\n        }\r\n\r\n        if (tx.type === 'BUY') inventory[key].stock += tx.weight_grams\r\n        if (tx.type === 'SELL') inventory[key].stock -= tx.weight_grams\r\n    })\r\n\r\n    return Object.values(inventory).filter((i: any) => i.stock !== 0)\r\n}\r\n\r\nexport async function getTransactions() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    return db.prepare(`\r\n        SELECT t.*, gt.name as gold_name, p.name as point_name\r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n        ORDER BY date DESC\r\n    `).all(userId)\r\n}\r\n","export {getSession as '00a5fb6db855bcb8de8eb3a3a932b31c246b050806'} from 'ACTIONS_MODULE0'\nexport {logout as '00bf6aff51c053136cb6843a038c949bec8344cd38'} from 'ACTIONS_MODULE0'\nexport {register as '40de66b91b194dec19db6ac662585f11b7e4a40d7e'} from 'ACTIONS_MODULE0'\nexport {login as '40fde23bb9f3b5528f0905b64385d2e2c58f4d95ea'} from 'ACTIONS_MODULE0'\nexport {getInventory as '00ab95d72063df75aa50e57cde3609728199fe6e11'} from 'ACTIONS_MODULE1'\nexport {getTransactions as '00fab7af394b8cefcf5dc4a8d853b75d19563c842f'} from 'ACTIONS_MODULE1'\nexport {buy as '4011e4ad4af21d24326eb2052b8e6074085bed4aed'} from 'ACTIONS_MODULE1'\nexport {sell as '404c8c67f791b7cd5144b3a290165d08875034dfd4'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"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"}