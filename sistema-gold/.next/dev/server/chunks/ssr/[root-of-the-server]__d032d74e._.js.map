{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Nick/Documents/Nick/Sistemas/SistemaCompraVenda/sistema-gold/src/actions/transactions.ts"],"sourcesContent":["'use server'\r\n\r\nimport db from '@/lib/db'\r\nimport { revalidatePath } from 'next/cache'\r\nimport { writeFile, mkdir } from 'fs/promises'\r\nimport path from 'path'\r\nimport { getSession } from './auth'\r\n\r\n// Helper to save file\r\nasync function saveFile(file: File | null) {\r\n    if (!file || file.size === 0) return null\r\n\r\n    const bytes = await file.arrayBuffer()\r\n    const buffer = Buffer.from(bytes)\r\n\r\n    const uploadDir = path.join(process.cwd(), 'public', 'uploads')\r\n    await mkdir(uploadDir, { recursive: true })\r\n\r\n    const filename = `${Date.now()}-${file.name.replace(/\\s/g, '_')}`\r\n    const filepath = path.join(uploadDir, filename)\r\n\r\n    await writeFile(filepath, buffer)\r\n    return `/uploads/${filename}`\r\n}\r\n\r\nexport async function buy(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    const weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const file = formData.get('receipt') as File\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit) \r\n        VALUES ('BUY', ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function sell(formData: FormData) {\r\n    const session = await getSession()\r\n    if (!session) return { error: 'N찾o autorizado' }\r\n    const userId = Number(session.sub)\r\n\r\n    const weight = parseFloat(formData.get('weight') as string)\r\n    const price = parseFloat(formData.get('price') as string)\r\n    const goldTypeId = Number(formData.get('gold_type_id'))\r\n    const pointId = Number(formData.get('point_id'))\r\n    const customer = formData.get('customer') as string\r\n    const unit = formData.get('unit') as string || 'g'\r\n\r\n    // Delivery fields\r\n    const deliveryCourier = formData.get('delivery_courier') as string\r\n    const deliveryCost = parseFloat(formData.get('delivery_cost') as string) || 0\r\n\r\n    const file = formData.get('receipt') as File\r\n\r\n    if (!weight || !price || !goldTypeId || !pointId) {\r\n        return { error: 'Preencha os campos obrigat처rios.' }\r\n    }\r\n\r\n    try {\r\n        const receiptPath = await saveFile(file)\r\n        const date = new Date().toISOString()\r\n\r\n        const stmt = db.prepare(`\r\n        INSERT INTO transactions (type, weight_grams, price, customer_name, receipt_path, date, gold_type_id, point_id, user_id, unit, delivery_courier, delivery_cost) \r\n        VALUES ('SELL', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `)\r\n        stmt.run(weight, price, customer, receiptPath, date, goldTypeId, pointId, userId, unit, deliveryCourier, deliveryCost)\r\n\r\n        revalidatePath('/dashboard/inventory')\r\n        revalidatePath('/dashboard/transactions')\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        return { error: error.message }\r\n    }\r\n}\r\n\r\nexport async function getInventory() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    // Calculate inventory\r\n    // Group by Point -> Gold Type -> Unit\r\n    const txs = db.prepare(`\r\n        SELECT t.type, t.weight_grams, t.unit, gt.name as gold_name, p.name as point_name \r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n    `).all(userId) as any[]\r\n\r\n    const inventory: any = {}\r\n\r\n    txs.forEach(tx => {\r\n        const point = tx.point_name || 'Geral'\r\n        const gold = tx.gold_name || 'Desconhecido'\r\n        const unit = tx.unit || 'g'\r\n        const key = `${point}-${gold}-${unit}`\r\n\r\n        if (!inventory[key]) {\r\n            inventory[key] = {\r\n                point,\r\n                gold,\r\n                unit,\r\n                stock: 0\r\n            }\r\n        }\r\n\r\n        if (tx.type === 'BUY') inventory[key].stock += tx.weight_grams\r\n        if (tx.type === 'SELL') inventory[key].stock -= tx.weight_grams\r\n    })\r\n\r\n    return Object.values(inventory).filter((i: any) => i.stock !== 0)\r\n}\r\n\r\nexport async function getTransactions() {\r\n    const session = await getSession()\r\n    if (!session) return []\r\n    const userId = Number(session.sub)\r\n\r\n    return db.prepare(`\r\n        SELECT t.*, gt.name as gold_name, p.name as point_name\r\n        FROM transactions t\r\n        LEFT JOIN gold_types gt ON t.gold_type_id = gt.id\r\n        LEFT JOIN points p ON t.point_id = p.id\r\n        WHERE t.user_id = ?\r\n        ORDER BY date DESC\r\n    `).all(userId)\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 184, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Nick/Documents/Nick/Sistemas/SistemaCompraVenda/sistema-gold/.next-internal/server/app/dashboard/transactions/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getSession as '0002959933141a8591005362d9782db40d573d8cf8'} from 'ACTIONS_MODULE0'\nexport {logout as '00a1b9d856be879042d75ff8dc8dfb1962524258ed'} from 'ACTIONS_MODULE0'\nexport {register as '40e0bd842711d0001166ef627af8cdd4fdfd29a8c8'} from 'ACTIONS_MODULE0'\nexport {login as '40e3529cc11f2a04b1381f754a6a7c944ce0f2ce39'} from 'ACTIONS_MODULE0'\nexport {getInventory as '008f922624bec3cd7d7127a70dee5cb7eb09f87f14'} from 'ACTIONS_MODULE1'\nexport {getTransactions as '00dee16e6190adbdc458be42dc5a61a99dbfa86c29'} from 'ACTIONS_MODULE1'\nexport {buy as '403b338f71653513c62afda809781b1cd68b6a1ec6'} from 'ACTIONS_MODULE1'\nexport {sell as '40d49c43eff74a425b8d9d5146453d76bb766db371'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AAIA"}}]
}